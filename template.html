<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR Report Template</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';">
    
    <!-- Inline essential Tailwind-like styles for security -->
    <style>
        .bg-gray-100 { background-color: #f3f4f6; }
        .min-h-screen { min-height: 100vh; }
        .p-8 { padding: 2rem; }
        .font-sans { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; }
        .text-slate-800 { color: #1e293b; }
        .max-w-4xl { max-width: 56rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .bg-white { background-color: #ffffff; }
        .p-12 { padding: 3rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .border { border-width: 1px; }
        .border-gray-100 { border-color: #f3f4f6; }
        .border-b-2 { border-bottom-width: 2px; }
        .border-slate-100 { border-color: #f1f5f9; }
        .pb-6 { padding-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-start { align-items: flex-start; }
        .items-center { align-items: center; }
        .gap-3 { gap: 0.75rem; }
        .gap-6 { gap: 1.5rem; }
        .w-10 { width: 2.5rem; }
        .h-10 { height: 2.5rem; }
        .bg-blue-600 { background-color: #2563eb; }
        .rounded { border-radius: 0.25rem; }
        .text-white { color: #ffffff; }
        .font-bold { font-weight: 700; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-slate-800 { color: #1e293b; }
        .text-right { text-align: right; }
        .mr-4 { margin-right: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .text-gray-500 { color: #6b7280; }
        .font-medium { font-weight: 500; }
        .bg-slate-50 { background-color: #f8fafc; }
        .p-6 { padding: 1.5rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .border-slate-100 { border-color: #f1f5f9; }
        .grid { display: grid; }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .mt-4 { margin-top: 1rem; }
        .pt-4 { padding-top: 1rem; }
        .border-t { border-top-width: 1px; }
        .border-slate-200 { border-color: #e2e8f0; }
        .mb-4 { margin-bottom: 1rem; }
        .pb-2 { padding-bottom: 0.5rem; }
        .border-b { border-bottom-width: 1px; }
        .text-lg { font-size: 1.125rem; }
        .font-semibold { font-weight: 600; }
        .text-slate-700 { color: #334155; }
        .questionnaire-section { margin-bottom: 2rem; }
    </style>

    <!-- LForms scripts are INJECTED by generate_reports.js -->

    <style>
        @media print {
            body { background-color: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            #report-container { box-shadow: none; border: none; max-width: 100%; margin: 0; padding: 0; }
            .lforms-form-control { border: none !important; background: none !important; }
        }
        .fhir-header-label { font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; }
        .fhir-header-value { font-size: 1rem; color: #111827; font-weight: 500; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8 font-sans text-slate-800">

    <div id="report-container" class="max-w-4xl mx-auto bg-white p-12 rounded-xl shadow-lg border border-gray-100">
        
        <div class="border-b-2 border-slate-100 pb-6 mb-8 flex justify-between items-start">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-xl">QR</div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">QuestionnaireResponse</h2>
                </div>
            </div>
            <div class="text-right mr-4">
                <div class="text-sm text-gray-500">Date</div>
                <div class="font-medium text-slate-800" id="reportDate"></div>
            </div>
        </div>

        <div id="enrichment-section" class="mb-8 bg-slate-50 p-6 rounded-lg border border-slate-100">
            <div class="grid grid-cols-3 gap-6">
                <div><div class="fhir-header-label">Patient</div><div class="fhir-header-value" id="pt-name">--</div></div>
                <div><div class="fhir-header-label">DOB</div><div class="fhir-header-value" id="pt-dob">--</div></div>
                <div><div class="fhir-header-label">MRN</div><div class="fhir-header-value" id="pt-mrn">--</div></div>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-200 grid grid-cols-2 gap-6">
                 <div><div class="fhir-header-label">Care Plan</div><div class="fhir-header-value" id="care-plan">--</div></div>
                <div><div class="fhir-header-label">Author</div><div class="fhir-header-value" id="care-author">--</div></div>
            </div>
        </div>

        <div id="lforms-container">Loading...</div>

    </div>

    <script>
        function getSafe(fn, defaultVal) {
            try { return fn(); } catch (e) { return defaultVal; }
        }

        window.onload = function() {
            document.getElementById('reportDate').innerText = new Date().toLocaleDateString();
        };

        // --- 1. SANITIZER (Removes orphans to prevent Crash) ---
        function sanitizeResponse(qItems, respItem, path = '') {
            if (!respItem) return null;
            if (!qItems) return null; 
            const validItems = [];
            let removedCount = 0;
            
            respItem.forEach(rItem => {
                const def = qItems.find(q => q.linkId === rItem.linkId);
                const currentPath = path ? `${path}.${rItem.linkId}` : rItem.linkId;
                
                if (def) {
                    // Item has definition - process children if any
                    if (rItem.item && rItem.item.length > 0) {
                        const originalChildCount = rItem.item.length;
                        const cleanedChildren = sanitizeResponse(def.item, rItem.item, currentPath);
                        
                        if (cleanedChildren && cleanedChildren.length > 0) {
                            rItem.item = cleanedChildren;
                            const removedChildCount = originalChildCount - cleanedChildren.length;
                            if (removedChildCount > 0) {
                                console.log(`[Sanitizer] Removed ${removedChildCount} orphaned child items from ${currentPath}`);
                            }
                        } else {
                            console.log(`[Sanitizer] Removed all child items from ${currentPath} (no valid definitions found)`);
                            delete rItem.item; 
                        }
                    }
                    
                    // Log what we're keeping
                    const answerCount = rItem.answer ? rItem.answer.length : 0;
                    const answerText = rItem.answer ? 
                        rItem.answer.map(a => {
                            if (a.valueString) return `"${a.valueString}"`;
                            if (a.valueCoding) return `${a.valueCoding.display || a.valueCoding.code}`;
                            if (a.valueInteger !== undefined) return a.valueInteger;
                            if (a.valueDecimal !== undefined) return a.valueDecimal;
                            if (a.valueBoolean !== undefined) return a.valueBoolean;
                            if (a.valueDate) return a.valueDate;
                            return '[complex answer]';
                        }).join(', ') : 'no answer';
                    
                    console.log(`[Sanitizer] ✓ Kept ${currentPath} (${answerCount} answers: ${answerText})`);
                    validItems.push(rItem);
                } else {
                    // Item has no definition - log removal
                    const answerInfo = rItem.answer ? ` with ${rItem.answer.length} answers` : ' (no answers)';
                    console.log(`[Sanitizer] ✗ REMOVED orphaned item: ${currentPath}${answerInfo} - no definition found`);
                    removedCount++;
                }
            });
            
            if (removedCount > 0) {
                console.log(`[Sanitizer] Summary for ${path || 'root'}: Kept ${validItems.length}, Removed ${removedCount} orphaned items`);
            }
            
            return validItems;
        }

        // --- 2. NORMALIZER (Fixes Invisible Answers) ---
        // If code matches but system/display is different, assume it's the same answer.
        function normalizeAnswers(qItems, respItem, path = '') {
            if (!respItem || !qItems) return;
            
            let totalNormalizations = 0;

            respItem.forEach(rItem => {
                const def = qItems.find(q => q.linkId === rItem.linkId);
                const currentPath = path ? `${path}.${rItem.linkId}` : rItem.linkId;
                
                if (def) {
                    // If Definition has options, check if our answer needs aligning
                    if (def.answerOption && rItem.answer) {
                        rItem.answer.forEach((ans, ansIndex) => {
                            if (ans.valueCoding) {
                                // Find match in Definition options by CODE only
                                const match = def.answerOption.find(opt => 
                                    opt.valueCoding && opt.valueCoding.code === ans.valueCoding.code
                                );
                                
                                if (match) {
                                    let changes = [];
                                    
                                    // 1. Fix System Mismatch (e.g. http vs https)
                                    if (ans.valueCoding.system !== match.valueCoding.system) {
                                        changes.push(`system: "${ans.valueCoding.system}" → "${match.valueCoding.system}"`);
                                        ans.valueCoding.system = match.valueCoding.system;
                                        totalNormalizations++;
                                    }
                                    
                                    // 2. Fix Missing/Different Display (Helps LForms render label)
                                    if (match.valueCoding.display && ans.valueCoding.display !== match.valueCoding.display) {
                                        changes.push(`display: "${ans.valueCoding.display || '(missing)'}" → "${match.valueCoding.display}"`);
                                        ans.valueCoding.display = match.valueCoding.display;
                                        totalNormalizations++;
                                    }
                                    
                                    if (changes.length > 0) {
                                        console.log(`[Normalizer] ✓ Fixed answer ${ansIndex + 1} for ${currentPath} [code: ${ans.valueCoding.code}]: ${changes.join(', ')}`);
                                    }
                                } else if (ans.valueCoding.code) {
                                    // Code exists in answer but not in definition options - potential issue
                                    console.log(`[Normalizer] ⚠ Warning: Answer code "${ans.valueCoding.code}" for ${currentPath} not found in definition options - may not display correctly`);
                                }
                            }
                        });
                        
                        // Log summary for this item
                        if (rItem.answer.length > 0) {
                            const answersDescription = rItem.answer.map(ans => {
                                if (ans.valueCoding) return `${ans.valueCoding.display || ans.valueCoding.code}`;
                                if (ans.valueString) return `"${ans.valueString}"`;
                                return '[other]';
                            }).join(', ');
                            console.log(`[Normalizer] Processed ${currentPath}: ${rItem.answer.length} answers (${answersDescription})`);
                        }
                    } else if (rItem.answer && rItem.answer.length > 0) {
                        // Item has answers but no definition options to normalize against
                        console.log(`[Normalizer] Skipped ${currentPath}: has ${rItem.answer.length} answers but no definition answerOptions to validate against`);
                    }

                    // Recurse
                    if (rItem.item) {
                        totalNormalizations += normalizeAnswers(def.item, rItem.item, currentPath);
                    }
                }
            });
            
            if (path === '' && totalNormalizations > 0) {
                console.log(`[Normalizer] Summary: Applied ${totalNormalizations} normalizations to ensure answer compatibility`);
            }
            
            return totalNormalizations;
        }

        function renderFromData(data) {
            try {
                // 1. Header - Extract info from Bundle or QuestionnaireResponse
                const p = data.patient || {};
                const qr = data.questionnaireResponse || {};
                const cp = data.carePlan || {};
                
                // Patient info - try Bundle first, then QR
                let patientName = 'N/A';
                let patientDob = 'N/A';
                let patientMrn = 'N/A';
                
                if (p.name && p.name[0]) {
                    // From Bundle Patient resource
                    const nameObj = p.name[0];
                    const given = nameObj.given ? nameObj.given.join(' ') : '';
                    const family = nameObj.family || '';
                    patientName = `${given} ${family}`.trim() || 'Unknown';
                    patientDob = p.birthDate || 'N/A';
                    patientMrn = getSafe(() => p.identifier[0].value, 'N/A');
                } else if (qr.subject) {
                    // From QuestionnaireResponse subject
                    patientName = qr.subject.display || qr.subject.reference || 'Unknown Patient';
                    // Try to extract additional QR metadata
                    patientDob = getSafe(() => qr.meta.lastUpdated ? new Date(qr.meta.lastUpdated).toLocaleDateString() : 'N/A', 'N/A');
                    patientMrn = getSafe(() => qr.subject.identifier ? qr.subject.identifier.value : 'N/A', 'N/A');
                }
                
                document.getElementById('pt-name').innerText = patientName;
                document.getElementById('pt-dob').innerText = patientDob;
                document.getElementById('pt-mrn').innerText = patientMrn;

                // CarePlan info - try Bundle first, then QR
                let carePlanInfo = 'N/A';
                let author = 'N/A';
                
                if (cp.category && cp.category.length > 0) {
                    // From Bundle CarePlan resource - extract category codes and displays
                    const categories = cp.category.map(cat => {
                        if (cat.coding && cat.coding.length > 0) {
                            return cat.coding.map(coding => 
                                `${coding.display || coding.code}${coding.code ? ` (${coding.code})` : ''}`
                            ).join(', ');
                        }
                        return 'Unknown Category';
                    }).join('; ');
                    carePlanInfo = categories;
                    author = getSafe(() => cp.author.display || cp.author.reference, 'N/A');
                } else {
                    // From QuestionnaireResponse fallback
                    carePlanInfo = qr.questionnaire ? qr.questionnaire.split('/').pop().split('|')[0] : 'N/A';
                    author = getSafe(() => qr.author.display || qr.author.reference, 'N/A');
                }
                
                document.getElementById('care-plan').innerText = carePlanInfo;
                document.getElementById('care-author').innerText = author;

                if (!window.LForms) throw new Error("LForms library not loaded");

                // Handle multiple questionnaires or single questionnaire
                if (data.combinedQuestionnaires && data.combinedQuestionnaires.length > 0) {
                    // Multiple questionnaires - render each in its own section
                    let combinedHTML = '';
                    
                    data.combinedQuestionnaires.forEach((qrData, index) => {
                        const sectionId = `lforms-section-${index}`;
                        combinedHTML += `
                            <div class="questionnaire-section mb-8">
                                <h3 class="text-lg font-semibold text-slate-700 mb-4 pb-2 border-b border-slate-200">
                                    ${qrData.title}
                                </h3>
                                <div id="${sectionId}"></div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('lforms-container').innerHTML = combinedHTML;
                    
                    // Render each questionnaire in its section
                    data.combinedQuestionnaires.forEach((qrData, index) => {
                        try {
                            const formDef = LForms.Util.convertFHIRQuestionnaireToLForms(qrData.questionnaire, "R4");
                            
                            // Process the response data
                            if (qrData.questionnaireResponse && qrData.questionnaireResponse.item) {
                                console.log(`[Processing] Starting data sanitization and normalization for questionnaire ${index + 1}: ${qrData.title}`);
                                
                                qrData.questionnaireResponse.item = sanitizeResponse(
                                    qrData.questionnaire.item, 
                                    qrData.questionnaireResponse.item
                                );
                                
                                normalizeAnswers(
                                    qrData.questionnaire.item,
                                    qrData.questionnaireResponse.item
                                );
                            }
                            
                            const formWithData = LForms.Util.mergeFHIRDataIntoLForms(
                                "QuestionnaireResponse", 
                                qrData.questionnaireResponse, 
                                formDef, 
                                "R4"
                            );
                            
                            LForms.Util.addFormToPage(formWithData, `lforms-section-${index}`, { preloading: false });
                        } catch (e) {
                            console.error(`Error rendering questionnaire ${index + 1}:`, e);
                        }
                    });
                } else {
                    // Single questionnaire - original behavior
                    const formDef = LForms.Util.convertFHIRQuestionnaireToLForms(data.questionnaire, "R4");
                    
                    if (data.questionnaireResponse && data.questionnaireResponse.item) {
                        console.log(`[Processing] Starting data sanitization and normalization for single questionnaire`);
                        
                        data.questionnaireResponse.item = sanitizeResponse(
                            data.questionnaire.item, 
                            data.questionnaireResponse.item
                        );
                        
                        normalizeAnswers(
                            data.questionnaire.item,
                            data.questionnaireResponse.item
                        );
                    }

                    const formWithData = LForms.Util.mergeFHIRDataIntoLForms("QuestionnaireResponse", data.questionnaireResponse, formDef, "R4");
                    LForms.Util.addFormToPage(formWithData, 'lforms-container', { preloading: false });
                }

            } catch (e) {
                var msg = e.toString();
                if (e.message) msg = e.message;
                console.error("LFORMS_CRASH: " + msg);
                const errDiv = document.createElement('div');
                errDiv.id = 'render-error';
                errDiv.innerText = "Error: " + msg;
                document.body.appendChild(errDiv);
            }
            
            setTimeout(() => {
                const doneDiv = document.createElement('div');
                doneDiv.id = 'render-complete';
                document.body.appendChild(doneDiv);
            }, 1000);
        }
    </script>
</body>
</html>