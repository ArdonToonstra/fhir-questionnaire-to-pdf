<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR Report Template</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LForms scripts are INJECTED by generate_reports.js -->

    <style>
        @media print {
            body { background-color: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            #report-container { box-shadow: none; border: none; max-width: 100%; margin: 0; padding: 0; }
            .lforms-form-control { border: none !important; background: none !important; }
        }
        .fhir-header-label { font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; }
        .fhir-header-value { font-size: 1rem; color: #111827; font-weight: 500; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8 font-sans text-slate-800">

    <div id="report-container" class="max-w-4xl mx-auto bg-white p-12 rounded-xl shadow-lg border border-gray-100">
        
        <div class="border-b-2 border-slate-100 pb-6 mb-8 flex justify-between items-start">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center text-white font-bold text-xl">QR</div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">QuestionnaireResponse</h2>
                </div>
            </div>
            <div class="text-right mr-4">
                <div class="text-sm text-gray-500">Date</div>
                <div class="font-medium text-slate-800" id="reportDate"></div>
            </div>
        </div>

        <div id="enrichment-section" class="mb-8 bg-slate-50 p-6 rounded-lg border border-slate-100">
            <div class="grid grid-cols-3 gap-6">
                <div><div class="fhir-header-label">Patient</div><div class="fhir-header-value" id="pt-name">--</div></div>
                <div><div class="fhir-header-label">DOB</div><div class="fhir-header-value" id="pt-dob">--</div></div>
                <div><div class="fhir-header-label">MRN</div><div class="fhir-header-value" id="pt-mrn">--</div></div>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-200 grid grid-cols-2 gap-6">
                 <div><div class="fhir-header-label">Care Plan</div><div class="fhir-header-value" id="care-plan">--</div></div>
                <div><div class="fhir-header-label">Author</div><div class="fhir-header-value" id="care-author">--</div></div>
            </div>
        </div>

        <div id="lforms-container">Loading...</div>

    </div>

    <script>
        function getSafe(fn, defaultVal) {
            try { return fn(); } catch (e) { return defaultVal; }
        }

        window.onload = function() {
            document.getElementById('reportDate').innerText = new Date().toLocaleDateString();
        };

        // --- 1. SANITIZER (Removes orphans to prevent Crash) ---
        function sanitizeResponse(qItems, respItem) {
            if (!respItem) return null;
            if (!qItems) return null; 
            const validItems = [];
            respItem.forEach(rItem => {
                const def = qItems.find(q => q.linkId === rItem.linkId);
                if (def) {
                    if (rItem.item && rItem.item.length > 0) {
                        const cleanedChildren = sanitizeResponse(def.item, rItem.item);
                        if (cleanedChildren && cleanedChildren.length > 0) rItem.item = cleanedChildren;
                        else delete rItem.item; 
                    }
                    validItems.push(rItem);
                }
            });
            return validItems;
        }

        // --- 2. NORMALIZER (Fixes Invisible Answers) ---
        // If code matches but system/display is different, assume it's the same answer.
        function normalizeAnswers(qItems, respItem) {
            if (!respItem || !qItems) return;

            respItem.forEach(rItem => {
                const def = qItems.find(q => q.linkId === rItem.linkId);
                if (def) {
                    // If Definition has options, check if our answer needs aligning
                    if (def.answerOption && rItem.answer) {
                        rItem.answer.forEach(ans => {
                            if (ans.valueCoding) {
                                // Find match in Definition options by CODE only
                                const match = def.answerOption.find(opt => 
                                    opt.valueCoding && opt.valueCoding.code === ans.valueCoding.code
                                );
                                
                                if (match) {
                                    // 1. Fix System Mismatch (e.g. http vs https)
                                    if (ans.valueCoding.system !== match.valueCoding.system) {
                                        console.log(`[Normalizer] Fixed System: ${rItem.linkId} (${ans.valueCoding.system} -> ${match.valueCoding.system})`);
                                        ans.valueCoding.system = match.valueCoding.system;
                                    }
                                    // 2. Fix Missing/Different Display (Helps LForms render label)
                                    if (match.valueCoding.display) {
                                        ans.valueCoding.display = match.valueCoding.display;
                                    }
                                }
                            }
                        });
                    }

                    // Recurse
                    if (rItem.item) normalizeAnswers(def.item, rItem.item);
                }
            });
        }

        function renderFromData(data) {
            try {
                // 1. Header - Extract info from Bundle or QuestionnaireResponse
                const p = data.patient || {};
                const qr = data.questionnaireResponse || {};
                const cp = data.carePlan || {};
                
                // Patient info - try Bundle first, then QR
                let patientName = 'N/A';
                let patientDob = 'N/A';
                let patientMrn = 'N/A';
                
                if (p.name && p.name[0]) {
                    // From Bundle Patient resource
                    const nameObj = p.name[0];
                    const given = nameObj.given ? nameObj.given.join(' ') : '';
                    const family = nameObj.family || '';
                    patientName = `${given} ${family}`.trim() || 'Unknown';
                    patientDob = p.birthDate || 'N/A';
                    patientMrn = getSafe(() => p.identifier[0].value, 'N/A');
                } else if (qr.subject) {
                    // From QuestionnaireResponse subject
                    patientName = qr.subject.display || qr.subject.reference || 'Unknown Patient';
                    // Try to extract additional QR metadata
                    patientDob = getSafe(() => qr.meta.lastUpdated ? new Date(qr.meta.lastUpdated).toLocaleDateString() : 'N/A', 'N/A');
                    patientMrn = getSafe(() => qr.subject.identifier ? qr.subject.identifier.value : 'N/A', 'N/A');
                }
                
                document.getElementById('pt-name').innerText = patientName;
                document.getElementById('pt-dob').innerText = patientDob;
                document.getElementById('pt-mrn').innerText = patientMrn;

                // CarePlan info - try Bundle first, then QR
                let carePlanInfo = 'N/A';
                let author = 'N/A';
                
                if (cp.category && cp.category.length > 0) {
                    // From Bundle CarePlan resource - extract category codes and displays
                    const categories = cp.category.map(cat => {
                        if (cat.coding && cat.coding.length > 0) {
                            return cat.coding.map(coding => 
                                `${coding.display || coding.code}${coding.code ? ` (${coding.code})` : ''}`
                            ).join(', ');
                        }
                        return 'Unknown Category';
                    }).join('; ');
                    carePlanInfo = categories;
                    author = getSafe(() => cp.author.display || cp.author.reference, 'N/A');
                } else {
                    // From QuestionnaireResponse fallback
                    carePlanInfo = qr.questionnaire ? qr.questionnaire.split('/').pop().split('|')[0] : 'N/A';
                    author = getSafe(() => qr.author.display || qr.author.reference, 'N/A');
                }
                
                document.getElementById('care-plan').innerText = carePlanInfo;
                document.getElementById('care-author').innerText = author;

                if (!window.LForms) throw new Error("LForms library not loaded");

                // Handle multiple questionnaires or single questionnaire
                if (data.combinedQuestionnaires && data.combinedQuestionnaires.length > 0) {
                    // Multiple questionnaires - render each in its own section
                    let combinedHTML = '';
                    
                    data.combinedQuestionnaires.forEach((qrData, index) => {
                        const sectionId = `lforms-section-${index}`;
                        combinedHTML += `
                            <div class="questionnaire-section mb-8">
                                <h3 class="text-lg font-semibold text-slate-700 mb-4 pb-2 border-b border-slate-200">
                                    ${qrData.title}
                                </h3>
                                <div id="${sectionId}"></div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('lforms-container').innerHTML = combinedHTML;
                    
                    // Render each questionnaire in its section
                    data.combinedQuestionnaires.forEach((qrData, index) => {
                        try {
                            const formDef = LForms.Util.convertFHIRQuestionnaireToLForms(qrData.questionnaire, "R4");
                            
                            // Process the response data
                            if (qrData.questionnaireResponse && qrData.questionnaireResponse.item) {
                                qrData.questionnaireResponse.item = sanitizeResponse(
                                    qrData.questionnaire.item, 
                                    qrData.questionnaireResponse.item
                                );
                                
                                normalizeAnswers(
                                    qrData.questionnaire.item,
                                    qrData.questionnaireResponse.item
                                );
                            }
                            
                            const formWithData = LForms.Util.mergeFHIRDataIntoLForms(
                                "QuestionnaireResponse", 
                                qrData.questionnaireResponse, 
                                formDef, 
                                "R4"
                            );
                            
                            LForms.Util.addFormToPage(formWithData, `lforms-section-${index}`, { preloading: false });
                        } catch (e) {
                            console.error(`Error rendering questionnaire ${index + 1}:`, e);
                        }
                    });
                } else {
                    // Single questionnaire - original behavior
                    const formDef = LForms.Util.convertFHIRQuestionnaireToLForms(data.questionnaire, "R4");
                    
                    if (data.questionnaireResponse && data.questionnaireResponse.item) {
                        data.questionnaireResponse.item = sanitizeResponse(
                            data.questionnaire.item, 
                            data.questionnaireResponse.item
                        );
                        
                        normalizeAnswers(
                            data.questionnaire.item,
                            data.questionnaireResponse.item
                        );
                    }

                    const formWithData = LForms.Util.mergeFHIRDataIntoLForms("QuestionnaireResponse", data.questionnaireResponse, formDef, "R4");
                    LForms.Util.addFormToPage(formWithData, 'lforms-container', { preloading: false });
                }

            } catch (e) {
                var msg = e.toString();
                if (e.message) msg = e.message;
                console.error("LFORMS_CRASH: " + msg);
                const errDiv = document.createElement('div');
                errDiv.id = 'render-error';
                errDiv.innerText = "Error: " + msg;
                document.body.appendChild(errDiv);
            }
            
            setTimeout(() => {
                const doneDiv = document.createElement('div');
                doneDiv.id = 'render-complete';
                document.body.appendChild(doneDiv);
            }, 1000);
        }
    </script>
</body>
</html>